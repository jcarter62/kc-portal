{% extends "base.html" %}

{% block title %}{{ "Edit" if page else "New" }} Page - {{ app_title | default('KC Portal') }}{% endblock %}

{% block content %}
    <h1>{{ "Edit" if page else "New" }} Page</h1>
    <form method="post">
        <input type="hidden" id="deleted_images" name="deleted_images" value="">
        <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" name="title" value="{{ page.title if page else '' }}" required>
        </div>
        <div class="mb-3">
            <label for="slug" class="form-label">Slug</label>
            <input type="text" class="form-control" id="slug" name="slug" value="{{ page.slug if page else '' }}" required>
        </div>
        <div class="mb-3">
            <label for="content" class="form-label">Content</label>
            <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="toggleHtml">
                <label class="form-check-label" for="toggleHtml">Edit Raw HTML</label>
            </div>
            <div id="content-editor" style="height: 400px;">{{ page.content | safe if page else '' }}</div>
            <textarea class="form-control" id="content" name="content" rows="10" style="display: none;">{{ page.content if page else '' }}</textarea>
        </div>
        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="is_public" name="is_public" {% if page and page.is_public %}checked{% endif %}>
            <label class="form-check-label" for="is_public">Public</label>
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
        <a href="/admin/pages" class="btn btn-secondary">Cancel</a>
    </form>

    <!-- Include Quill 2.0 library -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>

    <!-- Include Quill Blot Formatter -->
    <script src="https://cdn.jsdelivr.net/npm/quill-blot-formatter@1.0.5/dist/quill-blot-formatter.min.js"></script>

    <style>
        /* Custom Toolbar Buttons */
        .ql-img-100:after { content: "100%"; }
        .ql-img-75:after { content: "75%"; }
        .ql-img-50:after { content: "50%"; }
        .ql-img-auto:after { content: "Auto"; }

        .ql-table-insert-row-above:after { content: "+Row↑"; }
        .ql-table-insert-row-below:after { content: "+Row↓"; }
        .ql-table-insert-column-left:after { content: "+Col←"; }
        .ql-table-insert-column-right:after { content: "+Col→"; }
        .ql-table-delete-row:after { content: "-Row"; }
        .ql-table-delete-column:after { content: "-Col"; }
        .ql-table-delete-table:after { content: "Del Table"; }

        .ql-snow.ql-toolbar button {
            width: auto !important;
            padding: 0 5px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Quill 2.0 Table Styling in Editor */
        .ql-editor table {
            border-collapse: collapse;
            table-layout: fixed;
            width: 100%;
            margin-bottom: 1rem;
        }
        .ql-editor table td, .ql-editor table th {
            border: 1px solid #000;
            padding: 5px;
            min-width: 20px;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const Image = Quill.import('formats/image');
            class CustomImage extends Image {
                static formats(domNode) {
                    let formats = super.formats(domNode);
                    if (domNode.style.width) {
                        formats.width = domNode.style.width;
                    }
                    return formats;
                }
                format(name, value) {
                    if (name === 'width') {
                        if (value) {
                            this.domNode.style.width = value;
                            this.domNode.removeAttribute('width');
                            this.domNode.removeAttribute('height');
                            this.domNode.style.height = 'auto';
                        } else {
                            this.domNode.style.width = '';
                        }
                    } else {
                        super.format(name, value);
                    }
                }
            }
            Quill.register(CustomImage, true);
            Quill.register('modules/blotFormatter', QuillBlotFormatter.default);

            const textarea = document.getElementById('content');
            const slugInput = document.getElementById('slug');

            function setImageWidth(width) {
                const range = quill.getSelection();
                if (range) {
                    const [blot] = quill.getLeaf(range.index);
                    if (blot && blot.statics.blotName === 'image') {
                        blot.format('width', width);
                    }
                }
            }

            function imageHandler() {
                const input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'image/*');
                input.click();
                input.onchange = () => {
                    const file = input.files[0];
                    if (/^image\//.test(file.type)) {
                        const formData = new FormData();
                        formData.append('image', file);
                        formData.append('slug', slugInput.value);
                        fetch('/admin/upload-image', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(result => {
                            const range = quill.getSelection();
                            quill.insertEmbed(range.index, 'image', result.url);
                        })
                        .catch(error => console.error('Error:', error));
                    }
                };
            }

            const quill = new Quill('#content-editor', {
                theme: 'snow',
                modules: {
                    toolbar: {
                        container: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'align': [] }],
                            ['link', 'image', 'video'],
                            ['clean'],
                            ['img-100', 'img-75', 'img-50', 'img-auto'],
                            ['table', 'table-insert-row-above', 'table-insert-row-below', 'table-insert-column-left', 'table-insert-column-right', 'table-delete-row', 'table-delete-column', 'table-delete-table']
                        ],
                        handlers: {
                            'img-100': function() { setImageWidth('100%'); },
                            'img-75': function() { setImageWidth('75%'); },
                            'img-50': function() { setImageWidth('50%'); },
                            'img-auto': function() { setImageWidth(null); },
                            'image': imageHandler,
                            'table': function() {
                                this.quill.getModule('table').insertTable(3, 3);
                            },
                            'table-insert-row-above': function() {
                                this.quill.getModule('table').insertRowAbove();
                            },
                            'table-insert-row-below': function() {
                                this.quill.getModule('table').insertRowBelow();
                            },
                            'table-insert-column-left': function() {
                                this.quill.getModule('table').insertColumnLeft();
                            },
                            'table-insert-column-right': function() {
                                this.quill.getModule('table').insertColumnRight();
                            },
                            'table-delete-row': function() {
                                this.quill.getModule('table').deleteRow();
                            },
                            'table-delete-column': function() {
                                this.quill.getModule('table').deleteColumn();
                            },
                            'table-delete-table': function() {
                                this.quill.getModule('table').deleteTable();
                            }
                        }
                    },
                    table: true,
                    blotFormatter: {}
                }
            });

            // Track initial images
            let initialImages = new Set();
            quill.root.querySelectorAll('img').forEach(img => {
                if (img.src.includes('/media/')) {
                    initialImages.add(img.src.split('/media/')[1]);
                }
            });

            // Toggle HTML
            const toggleHtml = document.getElementById('toggleHtml');
            toggleHtml.addEventListener('change', function() {
                if (this.checked) {
                    textarea.value = quill.root.innerHTML;
                    textarea.style.display = 'block';
                    quill.container.style.display = 'none';
                    quill.getModule('toolbar').container.style.display = 'none';
                } else {
                    quill.setContents([]);
                    quill.clipboard.dangerouslyPasteHTML(0, textarea.value);
                    textarea.style.display = 'none';
                    quill.container.style.display = 'block';
                    quill.getModule('toolbar').container.style.display = 'block';
                }
            });

            // Form Submit
            document.querySelector('form').onsubmit = function() {
                if (!toggleHtml.checked) {
                    textarea.value = quill.root.innerHTML;
                }
                const finalImages = new Set();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = textarea.value;
                tempDiv.querySelectorAll('img').forEach(img => {
                    if (img.src.includes('/media/')) {
                        finalImages.add(img.src.split('/media/')[1]);
                    }
                });
                const deleted = [];
                initialImages.forEach(img => {
                    if (!finalImages.has(img)) deleted.push(img);
                });
                document.getElementById('deleted_images').value = deleted.join(',');
            };
        });
    </script>
{% endblock %}
